# 名词解释
- network namespace

> 隔离Linux网络设备，以及IP地址、端口、路由表、防火墙规则等网络资源。

- veth pair

> 连接两块虚拟以太网卡(veth)，一端发送的数据在另一端接收。常用于连接两个跨namespace的网络设备，如网桥和容器内的veth0网卡。

- Linux Bridge

> 二层网络设备，虚拟的网络交换机，连接同一个主机下的不同网络设备，通过Mac地址决定从哪个端口转发出去。

- 网卡的混杂模式

> 打开混杂模式后，一个网卡把所有接收到的网络流量都交给CPU，而不是只把Mac地址是它自己的单播帧以及多播、广播帧交给CPU。

# CNI

CNI是容器网络接口的缩写，K8s通过CNI统一了用于配置网络的插件接口，具体工作原理如下：
![](/images/Kubernetes/WeChat5e85f68dcf55b9379fd14c85ebea084d.png)

1. K8s调用CRI创建pause容器，生成对应的network namespace，此时应用容器并未创建；
2. CNI driver根据配置调用CNI插件；
3. CNI插件给pause容器配置正确的网络，Pod内的其它容器共用pause容器网络栈；
4. CNI插件在主机上进行相关的网络配置，以便实现pod与外部网络的互通；

# 网络方案
## flannel
flannel将某一协议的数据包封装在另一种网络协议中进行路由转发，以此构建overlay网络。有三种比较成熟的backend模式，分别是：UDP、VXLAN、Host Gateway。

### UDP模式
UDP模式底层基于tun设备，实现原理可参考下图：
![](/images/Kubernetes/WechatIMG486.png)
假设容器A ping 容器B的ip，源ip为10.244.1.96，目的ip为10.244.2.194，数据包将经过以下路径到达容器B：

1. 容器A查找本地路由表，发现访问10.244.0.0/16网段的下一跳是10.244.1.1；
2. 容器A发出arp请求，cni0网桥返回网桥的Mac地址；
3. 容器A封装数据包，目的ip地址为10.244.2.194，Mac地址为cni0网桥的Mac地址；
4. cni0网桥收到3层数据包后，查找主机路由表，发现10.244.0.0/16网段的数据是发给flannel0网卡；
5. flannel0网卡是个tun设备，收到数据后，通过socket将数据包转发给flanneld进程；
6. flanneld进程通过查找etcd可以获得10.244.2.0/24网段对应的对端主机ip和flanneld监听端口，将raw ip包封装成udp包，并通过主机网络发送至对端flanneld进程；
7. 对端flanneld进程收到数据包后进行解包，并将数据包转发给flannel0网卡；
8. flannel0网卡收到数据包后，查找主机路由表，发现10.244.2.0/24网段的数据包转发给cni0网桥，此时不知道10.244.2.194的Mac地址，向cni0网桥发起广播，得到容器B eth0的Mac地址；
9. 设置目的Mac地址后，通过cni0网桥发出，cni0网桥二层交换转发到容器eth0网卡，至此整个流程结束；
10. 回程报文按上述数据流原路返回。

### VXLAN模式
#### VXLAN原理
VXLAN的封包如下图：
![](/images/Kubernetes/vxlanpackage.png)

- VTEP： 进行VXLAN报文的处理，可以是交换机，也可以是宿主机
- VNI：一个VNI号对应一个租户
- etcd：分配主机ip段
- FDB表：交换机通过mac地址查找端口号的表，如果不在表中，向所有不是源端口的端口发送数据包，成为洪泛。

![](/images/Kubernetes/vxlan.png)

VXLAN转发过程：原始报文经过VTEP，被Linux内核添加上VXLAN包头及外层的UDP头部，再发送出去，对端VTEP接收到VXLAN报文后拆除外层UDP头部，并根据VXLAN头部的VNI把原始报文发送到目的服务器。

一个VXLAN报文需要确定两个地址信息：内层报文（对应目的虚拟机/容器）的MAC地址和外层报文（对应目的虚拟机/容器所在宿主机上的VTEP）IP地址。一般有多播和控制中心两种方式获得以上信息。

VXLAN的转发流程为：

1. 容器172.17.1.2/24 ping 172.17.1.3，查本地路由表，发现是转发到veth0；
2. 不知道目的mac地址，发起arp请求，源Mac地址为veth0 Mac 地址，目的Mac地址为255.255.255.255；
3. Arp包经过veth0、br0到达VTEP，VTEP查找FDB表发现目的Mac地址不在转发表内，又配置了多播组，将arp包发给多播组，组内的所有VTEP收到报文；
4. 其它VTEP收到报文后，去掉VXLAN包头，发现目的mac地址是255.255.255.255，是广播报文，转发给网桥，网桥广播给所有容器；
5. 容器记录源ip和源Mac地址的arp表，VTEP记录Mac地址到VTEP ip的FDB表；
6. 命中的容器并返回Mac地址，arp请求得到响应；
7. Ping包封装目的ip和目的Mac地址，发送至VXLAN0，VXLAN0查找FDB表，发现有记录，转发到对端VTEP端口，对端收到后解包，根据目的mac地址通过网桥转发到对端容器。

